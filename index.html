<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Счётчик пальцев</title>

  <style>
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b0f17; color:#e7eefc; }
    header { padding:14px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:12px; border:1px solid #2b3f63; background:#1b2a44; color:#fff; font-weight:700; }
    .pill { padding:8px 10px; border-radius:999px; border:1px solid #2b3f63; background:#132038; font-weight:700; }
    #status { padding: 0 14px 12px; opacity:.9; font-size:14px; }
    canvas { width: calc(100% - 28px); margin: 0 14px 14px; border-radius:16px; border:1px solid #2b3f63; background:#05070c; min-height:60vh; display:block; }
    /* Важно: video НЕ display:none (иначе иногда нет кадров) */
    #video { position: fixed; left:-10000px; top:0; width: 1px; height: 1px; opacity:0; }
  </style>

  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>

<body>

<header>
  <div class="pill">Пальцев: <span id="count">—</span></div>
  <div class="pill">Кадры: <span id="frames">0</span></div>
  <button id="btn">Запустить камеру</button>
</header>

<div id="status">Статус: ожидаю запуск…</div>

<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const btn = document.getElementById('btn');
const countEl = document.getElementById('count');
const framesEl = document.getElementById('frames');
const statusEl = document.getElementById('status');

const setStatus = (t) => statusEl.textContent = 'Статус: ' + t;

let running = false;
let stream = null;
let frames = 0;
let lastResultAt = 0;

const hands = new Hands({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7,
  selfieMode: true
});

hands.onResults((results) => {
  lastResultAt = Date.now();

  if (!results || !results.image) return;

  // подгоняем canvas под размер кадра
  canvas.width = results.image.width;
  canvas.height = results.image.height;

  // рисуем кадр
  ctx.drawImage(results.image, 0, 0);

  let fingers = 0;

  if (results.multiHandLandmarks && results.multiHandLandmarks.length) {
    const lm = results.multiHandLandmarks[0];

    // большой палец (selfieMode)
    if (lm[4].x > lm[3].x) fingers++;

    // остальные пальцы
    if (lm[8].y  < lm[6].y)  fingers++;
    if (lm[12].y < lm[10].y) fingers++;
    if (lm[16].y < lm[14].y) fingers++;
    if (lm[20].y < lm[18].y) fingers++;

    drawConnectors(ctx, lm, HAND_CONNECTIONS, { lineWidth: 4 });
    drawLandmarks(ctx, lm, { radius: 3 });
  }

  countEl.textContent = String(fingers);
});

async function startCamera() {
  setStatus('запрашиваю доступ к камере…');

  // На Android чаще всего норм работает facingMode: 'user'
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
    audio: false
  });

  video.srcObject = stream;

  // Важно дождаться, когда видео реально начнёт отдавать кадры
  await video.play();

  setStatus('камера даёт кадры, запускаю распознавание…');
}

async function loop() {
  if (!running) return;

  frames++;
  framesEl.textContent = String(frames);

  // Иногда полезно “пнуть” canvas даже до результатов, чтобы понимать что видео живое
  if (video.videoWidth && video.videoHeight) {
    // если ещё не задан размер canvas — зададим по видео
    if (!canvas.width || !canvas.height) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
    }
    // рисуем сырое видео как “диагностику”
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  }

  // отправляем кадр в MediaPipe
  try {
    await hands.send({ image: video });
  } catch (e) {
    console.error(e);
    setStatus('ОШИБКА MediaPipe: не удалось обработать кадр (см. консоль)');
  }

  // watchdog: если результатов нет долго — покажем подсказку
  if (Date.now() - lastResultAt > 3000) {
    setStatus('видео есть, но результатов от модели нет… (пробую дальше)');
  }

  requestAnimationFrame(loop);
}

function stopAll() {
  running = false;
  btn.textContent = 'Запустить камеру';
  setStatus('остановлено');

  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.srcObject = null;

  countEl.textContent = '—';
  framesEl.textContent = '0';
}

btn.addEventListener('click', async () => {
  if (running) {
    stopAll();
    return;
  }

  try {
    running = true;
    btn.textContent = 'Остановить';
    await startCamera();
    lastResultAt = Date.now();
    requestAnimationFrame(loop);
  } catch (e) {
    console.error(e);
    running = false;
    btn.textContent = 'Запустить камеру';
    setStatus('ОШИБКА запуска камеры: проверь разрешение/HTTPS');
    alert('Не удалось запустить камеру. Проверь разрешение камеры для сайта (иконка замка) и что сайт открыт по HTTPS.');
  }
});
</script>

</body>
</html>
