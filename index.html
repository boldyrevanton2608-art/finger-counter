<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Счётчик пальцев</title>

  <style>
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#0b0f17; color:#e7eefc; }
    header { padding:14px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:12px; border:1px solid #2b3f63; background:#1b2a44; color:#fff; font-weight:700; }
    .pill { padding:8px 10px; border-radius:999px; border:1px solid #2b3f63; background:#132038; font-weight:700; }
    #status { padding: 0 14px 12px; opacity:.9; font-size:14px; }
    canvas { width: calc(100% - 28px); margin: 0 14px 14px; border-radius:16px; border:1px solid #2b3f63; background:#05070c; min-height:60vh; display:block; }
    #video { position: fixed; left:-10000px; top:0; width: 1px; height: 1px; opacity:0; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>

<body>

<header>
  <div class="pill">Пальцев: <span id="count">—</span></div>
  <div class="pill">Кадры: <span id="frames">0</span></div>
  <button id="btn">Запустить камеру</button>
</header>

<div id="status">Статус: ожидаю запуск…</div>

<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const btn = document.getElementById('btn');
const countEl = document.getElementById('count');
const framesEl = document.getElementById('frames');
const statusEl = document.getElementById('status');

const setStatus = (t) => statusEl.textContent = 'Статус: ' + t;

let running = false;
let stream = null;
let frames = 0;
let lastResultAt = 0;
let lastHandSeenAt = 0;

const hands = new Hands({
  locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7,
  selfieMode: true
});

function countFingers(landmarks, handednessLabel, selfieMode=true) {
  // landmark: {x,y,z} normalized [0..1]
  // Индексы: 4,8,12,16,20 - кончики; 3 - сустав большого; 6,10,14,18 - PIP остальных
  let fingers = 0;

  const thumbTip = landmarks[4];
  const thumbIp  = landmarks[3];

  // Большой палец по X с учётом Left/Right и зеркала
  // handednessLabel: 'Left'/'Right' (это «рука человека», а не отражение)
  if (selfieMode) {
    // При зеркале направления меняются
    if (handednessLabel === 'Right') {
      if (thumbTip.x > thumbIp.x) fingers++;
    } else {
      if (thumbTip.x < thumbIp.x) fingers++;
    }
  } else {
    if (handednessLabel === 'Right') {
      if (thumbTip.x < thumbIp.x) fingers++;
    } else {
      if (thumbTip.x > thumbIp.x) fingers++;
    }
  }

  // Остальные пальцы: tip выше pip (y меньше)
  if (landmarks[8].y  < landmarks[6].y)  fingers++;
  if (landmarks[12].y < landmarks[10].y) fingers++;
  if (landmarks[16].y < landmarks[14].y) fingers++;
  if (landmarks[20].y < landmarks[18].y) fingers++;

  return fingers;
}

hands.onResults((results) => {
  lastResultAt = Date.now();

  if (!results || !results.image) return;

  // canvas под кадр
  canvas.width = results.image.width;
  canvas.height = results.image.height;

  // рисуем видео-кадр
  ctx.drawImage(results.image, 0, 0);

  let fingersText = '0';
  let status = 'ищу руку…';

  if (results.multiHandLandmarks && results.multiHandLandmarks.length) {
    lastHandSeenAt = Date.now();

    const lm = results.multiHandLandmarks[0];
    const handed = (results.multiHandedness && results.multiHandedness[0] && results.multiHandedness[0].label) || 'Right';

    const fingers = countFingers(lm, handed, true);
    fingersText = String(fingers);

    // рисуем скелет (чтобы было видно, что рука реально детектится)
    drawConnectors(ctx, lm, HAND_CONNECTIONS, { lineWidth: 4 });
    drawLandmarks(ctx, lm, { radius: 3 });

    status = `рука найдена (${handed})`;
  } else {
    // если руки нет — показываем "—"
    fingersText = '—';
  }

  countEl.textContent = fingersText;

  // статус с небольшим watchdog
  if (Date.now() - lastHandSeenAt > 2000) {
    setStatus('рука не найдена (приблизи ладонь, больше света, рука целиком в кадре)');
  } else {
    setStatus(status);
  }
});

async function startCamera() {
  setStatus('запрашиваю доступ к камере…');

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
    audio: false
  });

  video.srcObject = stream;
  await video.play();
  setStatus('камера даёт кадры, запускаю распознавание…');
}

async function loop() {
  if (!running) return;

  frames++;
  framesEl.textContent = String(frames);

  // Если по какой-то причине результаты не приходят — покажем подсказку
  if (Date.now() - lastResultAt > 3000) {
    setStatus('нет ответа от модели… (обнови страницу и попробуй ещё раз)');
  }

  try {
    await hands.send({ image: video });
  } catch (e) {
    console.error(e);
    setStatus('ошибка обработки кадра (см. консоль)');
  }

  requestAnimationFrame(loop);
}

function stopAll() {
  running = false;
  btn.textContent = 'Запустить камеру';
  setStatus('остановлено');

  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.srcObject = null;

  countEl.textContent = '—';
  framesEl.textContent = '0';
}

btn.addEventListener('click', async () => {
  if (running) {
    stopAll();
    return;
  }

  try {
    running = true;
    btn.textContent = 'Остановить';
    await startCamera();
    lastResultAt = Date.now();
    lastHandSeenAt = 0;
    requestAnimationFrame(loop);
  } catch (e) {
    console.error(e);
    running = false;
    btn.textContent = 'Запустить камеру';
    setStatus('ошибка запуска камеры: проверь разрешение/HTTPS');
    alert('Не удалось запустить камеру. Проверь разрешение камеры для сайта и что открыто по HTTPS.');
  }
});
</script>

</body>
</html>
