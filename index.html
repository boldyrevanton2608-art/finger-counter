<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Счётчик пальцев</title>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: #0b0f17;
      color: #e7eefc;
    }

    header {
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    button {
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid #2b3f63;
      background: #1b2a44;
      color: white;
      font-weight: 600;
    }

    #status {
      padding: 0 14px 12px;
      opacity: 0.85;
      font-size: 14px;
    }

    /* Окно камеры — видно сразу */
    canvas {
      width: calc(100% - 28px);
      margin: 0 14px 14px;
      border-radius: 16px;
      border: 1px solid #2b3f63;
      background: #05070c;
      min-height: 60vh;
      display: block;
    }

    /* ВАЖНО: НЕ display:none — иначе на Android Chrome могут не идти кадры */
    #video {
      position: fixed;
      left: -10000px;
      top: 0;
      width: 1px;
      height: 1px;
      opacity: 0;
    }
  </style>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>

<body>

<header>
  <div>Пальцев: <b id="count">—</b></div>
  <button id="btn">Запустить камеру</button>
</header>

<div id="status">Статус: ожидаю запуск…</div>

<!-- НЕ скрываем display:none -->
<video id="video" playsinline muted></video>
<canvas id="canvas"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const countEl = document.getElementById('count');
const btn = document.getElementById('btn');
const statusEl = document.getElementById('status');

const setStatus = (t) => statusEl.textContent = 'Статус: ' + t;

let running = false;
let camera = null;

const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7,
  selfieMode: true
});

hands.onResults(results => {
  if (!results || !results.image) return;

  // Размер canvas под реальный кадр
  canvas.width = results.image.width;
  canvas.height = results.image.height;

  // Рисуем кадр
  ctx.drawImage(results.image, 0, 0);

  let fingers = 0;

  if (results.multiHandLandmarks && results.multiHandLandmarks.length) {
    const lm = results.multiHandLandmarks[0];

    // Большой палец (для selfieMode обычно ок так)
    if (lm[4].x > lm[3].x) fingers++;

    // Остальные пальцы
    if (lm[8].y  < lm[6].y)  fingers++;
    if (lm[12].y < lm[10].y) fingers++;
    if (lm[16].y < lm[14].y) fingers++;
    if (lm[20].y < lm[18].y) fingers++;

    drawConnectors(ctx, lm, HAND_CONNECTIONS, { lineWidth: 4 });
    drawLandmarks(ctx, lm, { radius: 3 });
  }

  countEl.textContent = fingers;
});

btn.onclick = async () => {
  if (running) return;

  try {
    setStatus('запрашиваю доступ к камере…');

    camera = new Camera(video, {
      onFrame: async () => {
        await hands.send({ image: video });
      },
      width: 1280,
      height: 720
    });

    await camera.start();

    // Ключевое для Android Chrome: явно проиграть video
    await video.play();

    running = true;
    btn.textContent = 'Камера работает';
    setStatus('камера запущена, ищу руку…');
  } catch (e) {
    console.error(e);
    setStatus('ОШИБКА: нет кадров/нет доступа');
    alert('Не удалось получить видео-кадры.\nПроверь разрешение камеры и открой сайт по HTTPS.');
  }
};
</script>

</body>
</html>
